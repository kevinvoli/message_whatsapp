
## ğŸ“ RÃ¨gles MÃ©tier du Dispatcher

### RÃ¨gle 1 â€” Attribution des conversations (ONLINE)
- **R1.1** : Toute nouvelle conversation client est attribuÃ©e Ã  un commercial ONLINE via un round-robin strict.
- **R1.2** : Seuls les commerciaux ONLINE et Ã©ligibles sont dans la file.
- **R1.3** : Une conversation reste liÃ©e au commercial tant que : le commercial est ONLINE le client continue de rÃ©pondre

### RÃ¨gle 2 â€” DÃ©connexion
- **R2.1** : Ã€ la dÃ©connexion :
        le commercial sort immÃ©diatement de la file ONLINE
- **R2.2** : Si un client envoie un message aprÃ¨s la dÃ©connexion :
        la conversation est rÃ©injectÃ©e dans le dispatcher
- **R2.3** : Sans nouveau message client :
        la conversation reste gelÃ©e
- **R2.4** : Ã€ la reconnexion :
        le commercial revient en fin de file

###R7GLE 3 â€” Attribution en absence de commerciaux ONLINE (OFFLINE MODE)
- **R3.1** â€” Attribution obligatoire
Si aucun commercial nâ€™est ONLINE au moment oÃ¹ un client initie ou relance une conversation :
- la conversation est immÃ©diatement attribuÃ©e
- lâ€™attribution se fait Ã  un commercial OFFLINE
- **R3.2** : â€” StratÃ©gie dâ€™attribution OFFLINE
Lâ€™attribution OFFLINE suit une distribution Ã©quitable basÃ©e sur :
- le nombre de conversations dÃ©jÃ  attribuÃ©es
- lâ€™historique rÃ©cent (Ã©viter toujours les mÃªmes)
- sans tenir compte de lâ€™ordre de connexion
ğŸ‘‰ Objectif : charge Ã©quilibrÃ©e, pas prioritÃ© temps rÃ©el.
- **R3.3** â€” Persistance de lâ€™attribution
Une conversation attribuÃ©e OFFLINE :
- est persistÃ©e immÃ©diatement en base
    possÃ¨de :
- assignedCommercialId
- assignedAt
- assignedMode = OFFLINE
- R3.4 â€” Comportement Ã  la reconnexion
 Lorsquâ€™un commercial se connecte :
- il voit instantanÃ©ment toutes les conversations qui lui ont Ã©tÃ© attribuÃ©es (ONLINE ou OFFLINE)
- aucun redispatch automatique nâ€™a lieu Ã  la connexion
- **R3.5** : â€” RÃ©injection conditionnelle
Une conversation attribuÃ©e OFFLINE peut Ãªtre rÃ©injectÃ©e uniquement si :
- le commercial ne se connecte pas avant une heure limite configurable (ex : 09h00)
- ou une rÃ¨gle dâ€™inactivitÃ© est dÃ©clenchÃ©e (cf. rÃ¨gle 4)
- aucune conversation ne reste en attente sans propriÃ©taire

### RÃ¨gle 4 â€” InactivitÃ© commerciale (anti-sleep)
- **R4.1** : DÃ¨s quâ€™un commercial reÃ§oit une conversation : un timer de rÃ©ponse initiale dÃ©marre (ex: 5 min)
- ***R4.2** : Si aucune premiÃ¨re rÃ©ponse dans le dÃ©lai : la conversation est rÃ©injectÃ©e le commercial perd la prioritÃ©
- **R4.3** : Une rÃ©ponse valide = message envoyÃ© au client

### RÃ¨gle 5 â€” DÃ©lai lÃ©gal WhatsApp (24h)
- **R5.1** : AprÃ¨s 24h sans rÃ©ponse commerciale : Ã©criture bloquÃ©e
- **R5.2** : Lecture toujours autorisÃ©e
- **R5.3** : Le dÃ©lai est paramÃ©trable


### RÃ¨gle 5 : Communication WebSocket obligatoire
- **R5.1** : Toutes les communications front-back doivent passer par WebSocket
- **R5.2** : Exception : l'authentification initiale du commercial peut utiliser HTTP/REST

### RÃ¨gle 6 â€” WebSocket
- **R6.1** : Tout le flux temps rÃ©el passe par WebSocket
- **R6.2** : HTTP uniquement pour login / refresh token

---

## DÃ©composition en sous-tÃ¢ches Ã©lÃ©mentaires (PRÃŠT POUR IA / DEV)
        ### ğŸ§© MODULE 1 â€” Gestion des commerciaux
        - Connexion / dÃ©connexion
        - Gestion Ã©tat ONLINE / OFFLINE
        - File dâ€™attente circulaire

        ### ğŸ§© MODULE 2 â€” Dispatcher de conversations
        - Round-robin ONLINE
        - File OFFLINE
        - RÃ©injection sÃ©curisÃ©e
        - Verrou anti-double attribution
        ### ğŸ§© MODULE 3 â€” Timers & jobs
  
        - Timer 5 min premiÃ¨re rÃ©ponse
        - Cron 24h WhatsApp
        - Job de nettoyage OFFLINE
        ### ğŸ§© MODULE 4 â€” Droits & permissions
        - Lecture seule aprÃ¨s 24h
        - Blocage Ã©criture
        - RÃ¨gles reconnection
        
        ### ğŸ§© MODULE 5 â€” WebSocket Events
        - commercial:online
        - commercial:offline
        - conversation:assigned
        - conversation:reassigned
        - conversation:readonly
        
        ### ğŸ§© MODULE 6 â€” Frontend
        - Indicateurs live
        - Statuts conversations
        - Notifications
        - Filtres & recherche

ğŸ—ºï¸ Vue globale des modules

src/
â”œâ”€â”€ app.module.ts
â”œâ”€â”€ main.ts
â”‚
â”œâ”€â”€ core/                # Transversal (infra & utilitaires)
â”‚   â”œâ”€â”€ database/
â”‚   â”œâ”€â”€ websocket/
â”‚   â”œâ”€â”€ queue/
â”‚   â”œâ”€â”€ scheduler/
â”‚   â”œâ”€â”€ locks/
â”‚   â””â”€â”€ config/
â”‚
â”œâ”€â”€ auth/
â”‚
â”œâ”€â”€ commercial/          # Agents / commerciaux
â”‚
â”œâ”€â”€ conversation/
â”‚
â”œâ”€â”€ message/
â”‚
â”œâ”€â”€ dispatcher/          # CÅ’UR DU SYSTÃˆME
â”‚
â”œâ”€â”€ whatsapp/
â”‚
â”œâ”€â”€ realtime/
â”‚
â”œâ”€â”€ admin/
â”‚
â””â”€â”€ shared/

ğŸ”© CORE â€” Infrastructure transversale
core/database

TypeORM / Prisma

Transactions

Verrous pessimistes

database/
â”œâ”€â”€ database.module.ts
â”œâ”€â”€ database.service.ts
â””â”€â”€ repositories/

core/websocket

Abstraction au-dessus de @WebSocketGateway

websocket/
â”œâ”€â”€ websocket.module.ts
â”œâ”€â”€ socket-auth.guard.ts
â”œâ”€â”€ socket-events.enum.ts
â””â”€â”€ socket.service.ts

ğŸ‘‰ Aucun module mÃ©tier ne parle directement Ã  server.emit

core/queue

Pour :

OFFLINE queue

RÃ©injection

Timers

queue/
â”œâ”€â”€ queue.module.ts
â”œâ”€â”€ dispatcher.queue.ts
â””â”€â”€ offline.queue.ts

BullMQ / Redis recommandÃ©.

core/scheduler

Timers & cron

scheduler/
â”œâ”€â”€ scheduler.module.ts
â”œâ”€â”€ response-timeout.job.ts
â”œâ”€â”€ whatsapp-24h.job.ts
â””â”€â”€ reconnect-rebalance.job.ts

core/locks

Anti double attribution

locks/
â”œâ”€â”€ lock.service.ts   # Redis lock


MODULE commercial

ResponsabilitÃ© : lâ€™Ã©tat des commerciaux

commercial/
â”œâ”€â”€ commercial.module.ts
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ commercial.entity.ts
â”‚   â”œâ”€â”€ commercial.state.ts
â”‚   â””â”€â”€ commercial.policy.ts
â”œâ”€â”€ commercial.service.ts
â”œâ”€â”€ commercial.gateway.ts
â””â”€â”€ commercial.repository.ts

RÃ´les

Connexion / dÃ©connexion

ONLINE / OFFLINE

File circulaire

MODULE conversation

ResponsabilitÃ© : le cycle de vie

conversation/
â”œâ”€â”€ conversation.module.ts
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ conversation.entity.ts
â”‚   â”œâ”€â”€ conversation.status.ts
â”‚   â””â”€â”€ conversation.policy.ts
â”œâ”€â”€ conversation.service.ts
â”œâ”€â”€ conversation.repository.ts
â””â”€â”€ conversation.events.ts


Statuts :

NEW

ASSIGNED

WAITING

READ_ONLY

CLOSED

MODULE message

ResponsabilitÃ© : contenu & dÃ©lais

message/
â”œâ”€â”€ message.module.ts
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ message.entity.ts
â”‚   â””â”€â”€ message.policy.ts
â”œâ”€â”€ message.service.ts
â””â”€â”€ message.repository.ts

ğŸ§  MODULE dispatcher (LE CERVEAU)

Aucun WebSocket ici
Aucune DB directe
Que des dÃ©cisions

dispatcher/
â”œâ”€â”€ dispatcher.module.ts
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ dispatcher.service.ts   # Logique pure
â”‚   â”œâ”€â”€ rotation.strategy.ts
â”‚   â”œâ”€â”€ offline.strategy.ts
â”‚   â””â”€â”€ inactivity.strategy.ts
â”œâ”€â”€ dispatcher.facade.ts        # Orchestrateur
â”œâ”€â”€ dispatcher.events.ts
â””â”€â”€ dispatcher.listener.ts

Exemple

assignConversation(conversationId) {
  lock(conversationId)
  â†’ choisir stratÃ©gie
  â†’ dÃ©cider commercial
  â†’ Ã©mettre Ã©vÃ©nement
}

âš¡ MODULE realtime

Bridge WebSocket â†’ Front

realtime/
â”œâ”€â”€ realtime.module.ts
â”œâ”€â”€ realtime.gateway.ts
â”œâ”€â”€ realtime.service.ts
â””â”€â”€ realtime.mapper.ts

ğŸ› ï¸ MODULE admin

ParamÃ©trage dynamique

admin/
â”œâ”€â”€ admin.module.ts
â”œâ”€â”€ settings.service.ts
â””â”€â”€ settings.controller.ts

Flux clÃ© (exemple rÃ©el)
Client WhatsApp â†’ message
Webhook WhatsApp
 â†’ whatsapp.service
 â†’ message.service
 â†’ conversation.service
 â†’ dispatcher.facade
 â†’ dispatcher.domain
 â†’ dispatcher.event
 â†’ realtime.gateway
 â†’ Front